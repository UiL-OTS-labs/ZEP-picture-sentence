
import defs;

const int LINE_WIDTH = 1000;

// The test page of the trial. Initially two sentences will be visible
Page test_page {

    TestItem item;  // Trial parameters

    init()
    {
        fill_pattern_color = TEST_PAGE_COLOR;
    }

    // Enable to respond using the keyboard
    on_event:key_press()
    {
    }

    // Enable to respond via the BeexyBox
    on_event:message()
    {
    }

    VerticalLayout layout
    {
        on_event:init()
        {
            spacing = 10;
            height = 0;     // 0 means as big as possible
            is_visible = true;
            top_margin = 100;
            bottom_margin = 100;
            //options = LAYOUT_SHRINK_ITEMS_VER; 
        }

        HorGridLayout pictures
        {
            on_event:init()
            {
                hor_spacing = 40;
                ver_spacing = 40;
                width = 0;     // 0 means as big as possible
                wrap_count = 2;
                options = LAYOUT_SHRINK_ITEMS;
            }

            CanvasGadget pic1
            {
                on_event:init()
                {
                    fill_pattern_color = TEST_PAGE_STIMULUS_COLOR;
                    size = 300,300;
                }
            }
            
            CanvasGadget pic2
            {
                on_event:init()
                {
                    fill_pattern_color = TEST_PAGE_STIMULUS_COLOR;
                    size = 300,300;
                }
            }

            LabelGadget label1
            {
                on_event:init()
                {
                    text = "A";
                    font_family = TEST_PAGE_LABEL_FONT_FAMILY;
                    font_size = TEST_PAGE_LABEL_FONT_SIZE;
                }
            }

            LabelGadget label2
            {
                on_event:init()
                {
                    text = "B";
                    font_family = TEST_PAGE_LABEL_FONT_FAMILY;
                    font_size = TEST_PAGE_LABEL_FONT_SIZE;
                }
            }
        }
        
        Spacer {}

        CanvasGadget s1
        {
            on_event:init()
            {
                fill_pattern_color = TEST_PAGE_STIMULUS_COLOR;
                size = LINE_WIDTH,100;
                is_visible = true;
            }

            TextShape text
            {
                on_event:init()
                {
//                    size                = LINE_WIDTH,100;
                    font_family         = TEST_PAGE_STIMULUS_FONT_FAMILY;
                    font_size           = TEST_PAGE_STIMULUS_FONT_SIZE;
                    line_pattern_color  = TEST_PAGE_STIMULUS_TEXT_COLOR;
                    line_width          = LINE_WIDTH;
                }
            }

            time enable_sentence(string s, time t, dur d=-1ms)
            {
                text.text = s;
                text.start(t, d);
                return text.expected_start_time;
            }
        }

        HorizontalLayout buttons_s1
        {
            on_event:init()
            {
                spacing = 300;
                width = 0;     // 0 means as big as possible
//                options = LAYOUT_STRETCH_ITEMS;
            }

            ButtonGadget button_a
            {
                on_event:init()
                {
                    text = "A";
                    font_family = TEST_PAGE_BUTTON_FONT_FAMILY;
                    font_size = TEST_PAGE_BUTTON_FONT_SIZE;
                    width = 100;
                }
            }
            
            ButtonGadget button_b
            {
                on_event:init()
                {
                    text = "B";
                    font_family = TEST_PAGE_BUTTON_FONT_FAMILY;
                    font_size = TEST_PAGE_BUTTON_FONT_SIZE;
                    width = 100;
                }
            }
        }

        Spacer {}

        CanvasGadget s2
        {
            on_event:init()
            {
                fill_pattern_color  = TEST_PAGE_STIMULUS_COLOR;
                size = LINE_WIDTH,100;
            }
            
            TextShape text
            {
                on_event:init()
                {
//                    size = LINE_WIDTH,100;
                    font_family         = TEST_PAGE_STIMULUS_FONT_FAMILY;
                    font_size           = TEST_PAGE_STIMULUS_FONT_SIZE;
                    line_pattern_color  = TEST_PAGE_STIMULUS_TEXT_COLOR;
                    line_width          = LINE_WIDTH;
                }
            }
            
            time enable_sentence(string s, time t, dur d=-1ms)
            {
                text.text = s;
                text.start(t, d);
                return text.expected_start_time;
            }
        }

        HorizontalLayout buttons_s2
        {
            on_event:init()
            {
                spacing = 300;
                width = 0;     // 0 means as big as possible
                //options = LAYOUT_SPREAD_ITEMS;
            }
            
            ButtonGadget button_a
            {
                on_event:init()
                {
                    text = "A";
                    font_family = TEST_PAGE_BUTTON_FONT_FAMILY;
                    font_size = TEST_PAGE_BUTTON_FONT_SIZE;
                    width = 100;
                }
            }
            
            ButtonGadget button_b
            {
                on_event:init()
                {
                    text = "B";
                    font_family = TEST_PAGE_BUTTON_FONT_FAMILY;
                    font_size = TEST_PAGE_BUTTON_FONT_SIZE;
                    width = 100;
                }
            }
        }

        void enable_sentences(string s1, string s2, time onset)
        {
            layout.s1.enable_sentence(s1, onset);
            layout.s2.enable_sentence(s2, onset);
        }
    }

    void setup(int ntrials = -1, bool pr=false, string prompt="")
    {
        test_page_overlay.setup(this);

        // Show or hide prompt.
        if (pr)
            test_page_overlay.show_prompt(prompt);
        else
            test_page_overlay.show_prompt("");

        // Enable or disable the progress bar or disable when ntrials < 0        
        test_page_overlay.show_progress_bar(ntrials);

        // Enable button_box
        control.target = this;

        // Enable buttons codes.
        print_error("Enable the right button codes...\n");
    }

    void cleanup()
    {
        test_page_overlay.cleanup();
    }

    void action(Object caller, TestItem item, time reftime, int cycle)
    {
        time tref;
        this.item = item;

        tref = test_window1.show_test_page(this, tref + INTER_TRIAL_INTERVAL);

        layout.enable_sentences(item.s1, item.s2, tref);

        test_page_overlay.update_progress_bar(cycle);

        control.set_status(
            string(cycle)   + "  " +
            string(item.id) + "  "
            );

    }
    
    void action_answer(Object caller, TestItem item, time reftime, int cycle)
    {
    }

};
